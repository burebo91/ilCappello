<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>IL CAPPELLO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Stili CSS -->
    <style>
        /* Inserisci qui il tuo CSS */
        /* ... */
    </style>
</head>
<body>
    <!-- Schermata di login -->
    <div id="login">
        <h2>Seleziona il tuo nome</h2>
        <select id="userSelect">
            <option value="">-- Seleziona un utente --</option>
            <option value="Alex">Alex</option>
            <option value="Polly">Polly</option>
            <option value="Cristy">Cristy</option>
            <option value="Chuck">Chuck</option>
            <option value="Manny">Manny</option>
            <option value="Il Biondo">Il Biondo</option>
            <option value="Bencio">Bencio</option>
        </select>
        <button onclick="login()">Accedi</button>
    </div>

    <!-- Contenuto dell'applicazione -->
    <div id="app" style="display: none;">
        <h1>IL CAPPELLO</h1>

        <div class="container">
            <img id="hat" src="cappello.png" alt="Cappello" onclick="draw()">
            <div id="ticket">
                <h2 id="result"></h2>
            </div>
        </div>

        <div class="controls">
            <label for="mode">Scegli la modalità:</label>
            <select id="mode">
                <option value="names">Nomi</option>
                <option value="yesno">Sì o No</option>
            </select>
            <button onclick="draw()">Estrai</button>
        </div>

        <div id="history">
            <h2>Storico delle Estrazioni</h2>
            <ul id="historyList">
                <!-- Gli elementi della cronologia verranno aggiunti qui -->
            </ul>
        </div>
    </div>

    <!-- Includi gli SDK di Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <!-- Inizializza Firebase -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDo1rCk1GQt0YOp_XMB1fx3o3b-5FuC5oU",
            authDomain: "ilcappello.firebaseapp.com",
            projectId: "ilcappello",
            storageBucket: "ilcappello.appspot.com",
            messagingSenderId: "868385193610",
            appId: "1:868385193610:web:5c7168fa39efd4eba2b773",
            measurementId: "G-XYJ79F19Q8"
        };

        // Inizializza Firebase
        firebase.initializeApp(firebaseConfig);

        // Inizializza Firestore
        const db = firebase.firestore();
    </script>

    <!-- Il tuo codice JavaScript -->
    <script>
        // Il resto del tuo codice JavaScript
        let currentUser = null;

        function login() {
            const userSelect = document.getElementById('userSelect');
            currentUser = userSelect.value;

            if (currentUser) {
                document.getElementById('login').style.display = 'none';
                document.getElementById('app').style.display = 'block';

                loadHistory();
            } else {
                alert('Per favore, seleziona un utente.');
            }
        }

        const defaultNames = [
            "Alex",
            "Polly",
            "Cristy",
            "Chuck",
            "Manny",
            "Il Biondo",
            "Bencio"
        ];

        function draw() {
            const mode = document.getElementById('mode').value;
            let options = [];

            if (mode === 'names') {
                options = defaultNames;
            } else if (mode === 'yesno') {
                options = ['Sì', 'No'];
            }

            const hat = document.getElementById('hat');
            const ticket = document.getElementById('ticket');
            const resultElement = document.getElementById('result');

            // Reset animazioni e testo
            hat.classList.remove('shake', 'flip');
            ticket.classList.remove('open');
            resultElement.innerText = '';

            // Animazione del cappello (shake)
            hat.classList.add('shake');

            // Dopo l'animazione dello shake, il cappello si ribalta
            setTimeout(function() {
                hat.classList.remove('shake');
                hat.classList.add('flip');

                // Dopo il flip, mostra il bigliettino appallottolato
                setTimeout(function() {
                    // Bigliettino appare
                    ticket.classList.add('open');

                    // Dopo un breve ritardo, mostra il risultato
                    setTimeout(function() {
                        const randomIndex = Math.floor(Math.random() * options.length);
                        const result = options[randomIndex];
                        resultElement.innerText = result;

                        // Salva il risultato su Firestore
                        saveResultToFirestore(result);
                    }, 500); // Tempo per il bigliettino di aprirsi
                }, 500); // Tempo del flip
            }, 500); // Tempo dello shake
        }

        function saveResultToFirestore(result) {
            if (!currentUser) {
                alert('Devi effettuare il login prima di procedere.');
                return;
            }

            db.collection('history').add({
                user: currentUser,
                result: result,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            })
            .then((docRef) => {
                console.log('Risultato salvato con ID: ', docRef.id);
            })
            .catch((error) => {
                console.error('Errore nel salvare il risultato: ', error);
            });
        }

        function loadHistory() {
            db.collection('history').orderBy('timestamp', 'desc')
                .onSnapshot((querySnapshot) => {
                    const historyList = document.getElementById('historyList');
                    historyList.innerHTML = ''; // Svuota la lista corrente

                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const listItem = document.createElement('li');

                        const timestamp = data.timestamp ? data.timestamp.toDate() : new Date();
                        const timeString = timestamp.toLocaleString('it-IT');
                        const user = data.user;
                        const result = data.result;

                        listItem.textContent = `[${timeString}] ${user} ha estratto: ${result}`;

                        // Se l'utente è "Cristy", aggiungi un pulsante per eliminare
                        if (currentUser === 'Cristy') {
                            const deleteButton = document.createElement('button');
                            deleteButton.textContent = 'Elimina';
                            deleteButton.style.marginLeft = '10px';
                            deleteButton.onclick = function() {
                                deleteHistoryItem(doc.id);
                            };
                            listItem.appendChild(deleteButton);
                        }

                        historyList.appendChild(listItem);
                    });
                });
        }

        function deleteHistoryItem(id) {
            if (confirm('Sei sicuro di voler eliminare questo elemento?')) {
                db.collection('history').doc(id).delete()
                    .then(() => {
                        console.log('Elemento eliminato con successo');
                    })
                    .catch((error) => {
                        console.error('Errore nell\'eliminare l\'elemento: ', error);
                    });
            }
        }

        function closeTicket() {
            const ticket = document.getElementById('ticket');
            ticket.classList.remove('open');
            const hat = document.getElementById('hat');
            hat.classList.remove('flip');

            // Reset del testo del risultato
            const resultElement = document.getElementById('result');
            resultElement.innerText = '';
        }

        // Nasconde il bigliettino quando si cambia modalità
        document.getElementById('mode').addEventListener('change', function() {
            closeTicket();
        });
    </script>
</body>
</html>
